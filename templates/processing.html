{% extends 'base.html' %}

{% block title %}GDG Points Tracker - Processing{% endblock %}

{% block head %}
{{ super() }}
<style>
    .step {
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 15px;
        position: relative;
    }
    .step-pending {
        background-color: #f8f9fa;
        border-left: 5px solid #dee2e6;
    }
    .step-active {
        background-color: #e8f4fd;
        border-left: 5px solid #0d6efd;
    }
    .step-completed {
        background-color: #f0fff0;
        border-left: 5px solid #198754;
    }
    .step-error {
        background-color: #fff0f0;
        border-left: 5px solid #dc3545;
    }
    .step-spinner {
        width: 25px;
        height: 25px;
    }
    .progress-bar {
        transition: width 0.5s ease;
    }
    #log-container {
        max-height: 200px;
        overflow-y: auto;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 0.9rem;
        margin-top: 10px;
    }
    .log-entry {
        margin-bottom: 5px;
    }
    .log-info {
        color: #0d6efd;
    }
    .log-success {
        color: #198754;
    }
    .log-warning {
        color: #ffc107;
    }
    .log-error {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<!-- Store file_id as a data attribute in a hidden element -->
<div id="processing-data" data-file-id="{{ file_id }}" style="display:none;"></div>

<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Processing Participants</h1>
        
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">Progress</h3>
            </div>
            <div class="card-body">
                <div class="progress mb-3" style="height: 25px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                
                <div id="status-message" class="alert alert-info">
                    <span id="status-text">Initializing process...</span>
                </div>
                
                <div id="steps-container">
                    <div id="step-validate" class="step step-pending">
                        <h4><i class="bi bi-1-circle"></i> Validating CSV File</h4>
                        <p>Checking CSV structure and content...</p>
                        <div class="step-status"></div>
                    </div>
                    
                    <div id="step-parse" class="step step-pending">
                        <h4><i class="bi bi-2-circle"></i> Parsing Participant Data</h4>
                        <p>Reading and storing participant information...</p>
                        <div class="step-status"></div>
                    </div>
                    
                    <div id="step-scrape" class="step step-pending">
                        <h4><i class="bi bi-3-circle"></i> Scraping Points</h4>
                        <p>Retrieving points from participant profiles...</p>
                        <div class="step-status"></div>
                        <div class="current-batch mt-2" style="display: none;">
                            <p>Current batch: <span id="current-batch">0</span> of <span id="total-batches">0</span></p>
                            <div class="progress" style="height: 15px;">
                                <div id="batch-progress" class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="step-update" class="step step-pending">
                        <h4><i class="bi bi-4-circle"></i> Updating Database</h4>
                        <p>Storing points and calculating statistics...</p>
                        <div class="step-status"></div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h5>Processing Log</h5>
                    <div id="log-container"></div>
                </div>
            </div>
        </div>
        
        <div id="results-container" style="display: none;">
            <div class="alert alert-success">
                <h4 class="alert-heading"><i class="bi bi-check-circle"></i> Processing Complete!</h4>
                <p>All participants have been processed successfully.</p>
            </div>
            
            <div class="d-flex gap-2">
                <a href="{{ url_for('view_participants') }}" class="btn btn-primary">
                    <i class="bi bi-people"></i> View Participants
                </a>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Back to Home
                </a>
            </div>
            
            <div id="stats-container" class="row mt-4">
                <!-- Stats will be inserted here -->
            </div>
            
            <div class="table-responsive mt-4">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Weekly Points</th>
                            <th>Current Points</th>
                            <th>Profile</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body">
                        <!-- Results will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Helper functions - defined first to ensure they're available
    function addLogEntry(message, level) {
        const logContainer = document.getElementById('log-container');
        if (!logContainer) return;
        
        const entry = document.createElement('div');
        entry.className = `log-entry log-${level}`;
        
        const timestamp = new Date().toLocaleTimeString();
        entry.innerHTML = `[${timestamp}] ${message}`;
        
        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    function updateStatus(message, type) {
        const statusDiv = document.getElementById('status-message');
        const statusText = document.getElementById('status-text');
        if (!statusDiv || !statusText) return;
        
        statusText.textContent = message;
        
        // Update alert class
        statusDiv.className = 'alert';
        if (type === 'info') {
            statusDiv.classList.add('alert-info');
        } else if (type === 'success') {
            statusDiv.classList.add('alert-success');
        } else if (type === 'warning') {
            statusDiv.classList.add('alert-warning');
        } else if (type === 'error') {
            statusDiv.classList.add('alert-danger');
        }
    }

    function updateProgressBar(percent) {
        const progressBar = document.getElementById('progress-bar');
        if (!progressBar) return;
        
        progressBar.style.width = `${percent}%`;
        progressBar.setAttribute('aria-valuenow', percent);
        progressBar.textContent = `${percent}%`;
    }
    
    function updateBatchProgress(current, total) {
        const progressBar = document.getElementById('batch-progress');
        if (!progressBar) return;
        
        const percent = Math.floor((current / total) * 100);
        progressBar.style.width = `${percent}%`;
        progressBar.setAttribute('aria-valuenow', percent);
        progressBar.textContent = `${percent}%`;
    }
    
    function updateStepStatus(stepId, status) {
        const step = document.getElementById(stepId);
        if (!step) return;
        
        step.className = `step step-${status}`;
        
        const statusDiv = step.querySelector('.step-status');
        if (!statusDiv) return;
        
        if (status === 'active') {
            statusDiv.innerHTML = '<div class="spinner-border text-primary step-spinner" role="status"><span class="visually-hidden">Loading...</span></div>';
        } else if (status === 'completed') {
            statusDiv.innerHTML = '<i class="bi bi-check-circle-fill text-success" style="font-size: 1.5rem;"></i>';
        } else if (status === 'error') {
            statusDiv.innerHTML = '<i class="bi bi-exclamation-circle-fill text-danger" style="font-size: 1.5rem;"></i>';
        } else {
            statusDiv.innerHTML = '';
        }
    }
    
    // Get the file ID from the data attribute
    function getFileId() {
        const processingDataElement = document.getElementById('processing-data');
        if (!processingDataElement) {
            console.error('Processing data element not found');
            return null;
        }
        return processingDataElement.getAttribute('data-file-id');
    }
    
    // Main processing function
    function startProcessing() {
        // Get the file ID from the DOM element
        const fileId = getFileId();
        
        if (!fileId) {
            addLogEntry('No file ID provided', 'error');
            updateStatus('Error: No file ID provided', 'error');
            return;
        }
        
        // Start the first step
        validateCSV(fileId);
    }
    
    function validateCSV(fileId) {
        updateStepStatus('step-validate', 'active');
        updateStatus('Validating CSV file...', 'info');
        addLogEntry('Starting CSV validation...', 'info');
        
        fetch(`/api/validate_csv/${fileId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStepStatus('step-validate', 'completed');
                    addLogEntry(`CSV validation successful: ${data.message}`, 'success');
                    updateProgressBar(20);
                    
                    // Move to next step
                    parseParticipants(fileId);
                } else {
                    updateStepStatus('step-validate', 'error');
                    addLogEntry(`CSV validation failed: ${data.message}`, 'error');
                    updateStatus(`Error: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                updateStepStatus('step-validate', 'error');
                addLogEntry(`Error validating CSV: ${error}`, 'error');
                updateStatus('Error validating CSV file', 'error');
            });
    }
    
    function parseParticipants(fileId) {
        updateStepStatus('step-parse', 'active');
        updateStatus('Parsing participant data...', 'info');
        addLogEntry('Starting to parse participant data...', 'info');
        
        fetch(`/api/parse_participants/${fileId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStepStatus('step-parse', 'completed');
                    addLogEntry(`Parsed ${data.count} participants successfully`, 'success');
                    updateProgressBar(40);
                    
                    // Set up batch information
                    document.getElementById('total-batches').textContent = data.batches;
                    document.querySelector('.current-batch').style.display = 'block';
                    
                    // Move to next step
                    scrapePoints(fileId, 1, data.batches);
                } else {
                    updateStepStatus('step-parse', 'error');
                    addLogEntry(`Parsing failed: ${data.message}`, 'error');
                    updateStatus(`Error: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                updateStepStatus('step-parse', 'error');
                addLogEntry(`Error parsing participants: ${error}`, 'error');
                updateStatus('Error parsing participant data', 'error');
            });
    }
    
    function scrapePoints(fileId, batchNum, totalBatches) {
        updateStepStatus('step-scrape', 'active');
        const currentBatchElement = document.getElementById('current-batch');
        if (currentBatchElement) {
            currentBatchElement.textContent = batchNum;
        }
        updateBatchProgress(batchNum, totalBatches);
        
        updateStatus(`Scraping points for batch ${batchNum}/${totalBatches}...`, 'info');
        addLogEntry(`Processing batch ${batchNum}/${totalBatches}...`, 'info');
        
        fetch(`/api/scrape_batch/${fileId}/${batchNum}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogEntry(`Batch ${batchNum} completed: ${data.processed} participants processed`, 'success');
                    
                    if (data.warnings && data.warnings.length > 0) {
                        data.warnings.forEach(warning => {
                            addLogEntry(`Warning: ${warning}`, 'warning');
                        });
                    }
                    
                    // Update progress
                    const scrapeProgress = 40 + Math.floor((batchNum / totalBatches) * 40);
                    updateProgressBar(scrapeProgress);
                    
                    // Check if there are more batches
                    if (batchNum < totalBatches) {
                        // Process next batch
                        setTimeout(() => {
                            scrapePoints(fileId, batchNum + 1, totalBatches);
                        }, 500);
                    } else {
                        // All batches completed
                        updateStepStatus('step-scrape', 'completed');
                        addLogEntry('All batches processed successfully', 'success');
                        
                        // Move to next step
                        finalizeResults(fileId);
                    }
                } else {
                    addLogEntry(`Batch ${batchNum} error: ${data.message}`, 'error');
                    
                    if (data.canContinue) {
                        addLogEntry('Continuing with next batch...', 'warning');
                        
                        if (batchNum < totalBatches) {
                            setTimeout(() => {
                                scrapePoints(fileId, batchNum + 1, totalBatches);
                            }, 500);
                        } else {
                            updateStepStatus('step-scrape', 'completed');
                            finalizeResults(fileId);
                        }
                    } else {
                        updateStepStatus('step-scrape', 'error');
                        updateStatus(`Error: ${data.message}`, 'error');
                    }
                }
            })
            .catch(error => {
                addLogEntry(`Error processing batch ${batchNum}: ${error}`, 'error');
                
                // Try to continue with next batch
                if (batchNum < totalBatches) {
                    setTimeout(() => {
                        scrapePoints(fileId, batchNum + 1, totalBatches);
                    }, 500);
                } else {
                    updateStepStatus('step-scrape', 'error');
                    finalizeResults(fileId);
                }
            });
    }
    
    function finalizeResults(fileId) {
        updateStepStatus('step-update', 'active');
        updateStatus('Finalizing results...', 'info');
        addLogEntry('Updating database with final results...', 'info');
        
        fetch(`/api/finalize_results/${fileId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStepStatus('step-update', 'completed');
                    updateProgressBar(100);
                    addLogEntry('Database updated successfully', 'success');
                    updateStatus('Processing completed successfully!', 'success');
                    
                    // Display results
                    displayResults(data.results, data.stats);
                } else {
                    updateStepStatus('step-update', 'error');
                    addLogEntry(`Error finalizing results: ${data.message}`, 'error');
                    updateStatus(`Error: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                updateStepStatus('step-update', 'error');
                addLogEntry(`Error finalizing results: ${error}`, 'error');
                updateStatus('Error updating database', 'error');
            });
    }
    
    function displayResults(results, stats) {
        // Show results container
        const resultsContainer = document.getElementById('results-container');
        if (!resultsContainer) return;
        resultsContainer.style.display = 'block';
        
        // Display stats
        const statsContainer = document.getElementById('stats-container');
        if (!statsContainer) return;
        statsContainer.innerHTML = `
            <div class="col-md-4">
                <div class="card bg-light mb-3">
                    <div class="card-body text-center">
                        <h5 class="card-title">Total Participants</h5>
                        <p class="card-text display-4">${stats.totalParticipants}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light mb-3">
                    <div class="card-body text-center">
                        <h5 class="card-title">Success Rate</h5>
                        <p class="card-text display-4">${stats.successRate}%</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light mb-3">
                    <div class="card-body text-center">
                        <h5 class="card-title">Processing Time</h5>
                        <p class="card-text display-4">${stats.processingTime}s</p>
                    </div>
                </div>
            </div>
        `;
        
        // Display results table
        const tableBody = document.getElementById('results-table-body');
        if (!tableBody) return;
        tableBody.innerHTML = '';
        
        results.forEach((result, index) => {
            const row = document.createElement('tr');
            
            const statusClass = result.status === 'success' ? 'bg-success' : 'bg-warning';
            const weeklyPoints = result.weekly_points === 'N/A (First upload)' 
                ? '<span class="badge bg-info">First upload</span>'
                : result.weekly_points;
                
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${result.name}</td>
                <td>${weeklyPoints}</td>
                <td>${result.current_points}</td>
                <td>
                    <a href="${result.profile_url}" target="_blank" class="btn btn-sm btn-outline-primary">
                        View Profile
                    </a>
                </td>
                <td><span class="badge ${statusClass}">${result.status}</span></td>
            `;
            
            tableBody.appendChild(row);
        });
    }
    
    // Start processing when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Log that the page is loaded
        console.log('Processing page loaded');
        console.log('File ID from data attribute:', getFileId());
        
        try {
            // Start the processing
            startProcessing();
        } catch (error) {
            console.error('Error during process initialization:', error);
            addLogEntry(`Error: ${error.message}`, 'error');
            updateStatus(`Error during initialization: ${error.message}`, 'error');
        }
    });
</script>
{% endblock %} 